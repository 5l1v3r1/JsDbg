<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <title>Struct Diff</title>
    <link rel="stylesheet" type="text/css" href="/common.css">
    <script src="/jsdbg.js" type="text/javascript"></script>
    <script src="/dbgobject/dbgobject.js" type="text/javascript"></script>
    <script type="text/javascript">
        function init() {
            document.querySelector(".type").value = window.localStorage.getItem("struct-diff.type");
            document.querySelectorAll(".pointer")[0].value = window.sessionStorage.getItem("struct-diff.pointer0");
            document.querySelectorAll(".pointer")[1].value = window.sessionStorage.getItem("struct-diff.pointer1");
            document.getElementById("recurse").checked = window.sessionStorage.getItem("struct-diff.recurse") === "true" ? true : false;

            if (document.querySelector(".type").value.length > 0) {
                document.querySelector(".pointer").focus();
            } else {
                document.querySelector(".type").focus();
            }

            document.querySelector("button").addEventListener("click", function() {
                var type = document.querySelector(".type").value;
                var pointer1 = document.querySelectorAll(".pointer")[0].value;
                var pointer2 = document.querySelectorAll(".pointer")[1].value;
                var shouldRecurse = document.getElementById("recurse").checked;

                window.localStorage.setItem("struct-diff.type", type);
                window.sessionStorage.setItem("struct-diff.pointer0", pointer1);
                window.sessionStorage.setItem("struct-diff.pointer1", pointer2);
                window.sessionStorage.setItem("struct-diff.recurse", shouldRecurse);

                if (type.indexOf("!") < 0) {
                    alert("Please enter a type, prefixed by the module.");
                    return;
                }

                if (isNaN(parseInt(pointer1)) || isNaN(parseInt(pointer2))) {
                    alert("Please enter valid pointer values.");
                    return;
                }

                var module = type.substr(0, type.indexOf("!"));
                var typename = type.substr(type.indexOf("!") + 1);

                var object1 = new DbgObject(module, typename, parseInt(pointer1, 16));
                var object2 = new DbgObject(module, typename, parseInt(pointer2, 16));

                // get the structure size in a cheesy way off of DbgObject
                var structureSize = parseInt(object1.idx(1).ptr()) - parseInt(object1.ptr());

                // get some byte arrays.
                var array1 = object1.as("char").array(structureSize);
                var array2 = object2.as("char").array(structureSize);

                // find the differences
                var differences = [];
                array1.forEach(function(v, i) {
                    if (v != array2[i]) {
                        differences.push(i);
                    }
                });

                function expandArrays(fields) {
                    var result = [];
                    fields.forEach(function (field) {
                        if (field.value.isArray) {
                            for (var i = 0; i < field.value.arrayLength; ++i) {
                                var value = field.value.idx(i);
                                result.push({
                                    "name": field.name + "[" + i + "]",
                                    "offset": field.offset + (parseInt(value.ptr()) - parseInt(field.value.ptr())),
                                    "value": value
                                });
                            }
                        } else {
                            result.push(field);
                        }
                    });

                    return result;
                }

                function recursivelyGetFields(array, field, offset, prefix) {
                    field.offset += offset;
                    field.name = prefix + (prefix.length > 0 ? "." : "") + field.name;

                    var includeField = false;
                    try {
                        var recursiveFields = expandArrays(field.value.fields());
                        if (recursiveFields.length == 0) {
                            includeField = true;
                        } else {
                            recursiveFields.forEach(function(innerField) {
                                recursivelyGetFields(array, innerField, field.offset, field.name);
                            });
                        }
                    } catch (ex) { 
                        includeField = true;
                    }

                    if (includeField) {
                        array.push(field);
                    }
                }

                // get the fields.
                if (shouldRecurse) {
                    var fields = [];
                    expandArrays(object1.fields()).forEach(function(f) {
                        recursivelyGetFields(fields, f, 0, "");
                    });
                } else {
                    var fields = object1.fields();
                }

                fields.sort(function(a, b) { return a.offset - b.offset; });

                var fieldsAtCurrentOffset = [];
                var fieldsAtLastOffset = [];

                var differentFields = [];
                var currentDifferenceIndex = 0;

                for (var i = 0; i < fields.length; ++i) {
                    if (fieldsAtCurrentOffset.length > 0 && fieldsAtCurrentOffset[0].offset != fields[i].offset) {
                        fieldsAtLastOffset = fieldsAtCurrentOffset;
                        fieldsAtCurrentOffset = [];
                    }
                    fieldsAtCurrentOffset.push(fields[i]);

                    var didPushField = false;
                    while (fields[i].offset > differences[currentDifferenceIndex]) {
                        // We just passed the field.
                        if (!didPushField) {
                            fieldsAtLastOffset.forEach(function (f) {
                                if (f.value.bitcount > 0) {
                                    if (object1.f(f.name).val() != object2.f(f.name).val()) {
                                        differentFields.push(f);
                                    }
                                } else {
                                    differentFields.push(f);
                                }
                            });
                            didPushField = true;
                        }
                        currentDifferenceIndex++;
                    }
                }

                var html = differentFields.map(function(field) {
                    var f1 = object1.f(field.name);
                    var f2 = object2.f(field.name);

                    var val1 = f1.ptr();
                    var val2 = f2.ptr();

                    if (!field.value.isPointer()) {
                        try {
                            val1 = f1.val();
                            val2 = f2.val();
                        } catch (ex) { }
                    }

                    return [field.name, field.value.typeDescription().replace("<", "&lt;").replace(">", "&gt;"), "0x" + field.offset.toString(16), val1, val2];
                });

                html = html.map(function(cells) {
                    return "<td>" + cells.join("</td><td>") + "</td>";
                });

                if (html.length > 0) {
                    document.getElementById("results").innerHTML = 
                        "<table><tr><th>Field</th><th>Type</th><th>Offset</th><th>" + object1.ptr() + "</th><th>" + object2.ptr() + "</th></tr>" +
                        "<tr>" + html.join("</tr><tr>") + "</tr></table>";
                } else {
                    document.getElementById("results").innerHTML = "<h3>No difference!</h3>";
                }
            });
        }

        document.addEventListener("DOMContentLoaded", init);
    </script>
    <style type="text/css">
        .type {
            width:30em;
        }

        table {
            border-collapse:collapse;
        }

        td {
            padding:0.2em 1em;
        }

        tr:nth-of-type(2n) {
            background:#eee;
        }

        #results {
            margin-top:1em;
        }
    </style>
</head>
<body>
    <input class="type" type="text" placeholder="Type (e.g. mshtml!CFancyFormat)" />
    <input class="pointer" type="text" placeholder="Pointer 1" />
    <input class="pointer" type="text" placeholder="Pointer 2" />
    <button>Diff!</button>
    <input id="recurse" type="checkbox" /><label for="recurse">Show nested fields</label>
    <div id="results"></div>
</body>
</html>